<head>
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="http://code.highcharts.com/highcharts.js"></script>
	<style type="text/css">
		div#input {background-color:red;}
		div.distroGraph {width:49%;height:150px;display:inline-block}
		div.outputGraph {height:250px}
	</style>
</head>

<body>
<div id='constants'>
	<div id='arrivalDistGraph' class='distroGraph'></div>
	<div id='loadDistGraph' class='distroGraph'></div>
</div>
<div id='input'>
	<label>simDays</label><input id='simDays' type='text' value='1'/>
	<label>nodesPerUser</label><input id='nodesPerUser' type='text' value='1'/>
	<label>usersPerDay</label><input id='usersPerDay' type='text' value='45'/>
	<label>computeNodes</label><input id='computeNodes' type='text' value='10'/>
	<label>queueDepth</label><input id='queueDepth' type='text' value='1000000'/>
	<button onclick='javascript:execute()'>Re-execute</button>
</div>
<div id='output'>
	<div id='arrivalData' class='outputGraph'></div>
	<div id='workAndQueue' class='outputGraph'></div>
</div>

</body>

<script>
	// Probability Mass Function Object
	function ProbMass(eventPairs) {
		this.eventPairs = eventPairs
		// Todo: normalize?
	}
	ProbMass.prototype.sample = function() {
		// Todo: optimize this horrendous sampling code.
		function randomChoice(inList) {return inList[Math.floor(Math.random() * inList.length)]}
		var sampleList = []
		for (var i=0;i<this.eventPairs.length;i++) {
			for (var j=0;j<this.eventPairs[i][1];j++) {
				sampleList.push(this.eventPairs[i][0])
			}
		}
		return randomChoice(sampleList)
	}
	ProbMass.prototype.toHighChartDesc = function(renderPlace) {
		// TODO: make this more like the linked picture.
		// http://upload.wikimedia.org/wikipedia/commons/thumb/8/85/Discrete_probability_distrib.svg/200px-Discrete_probability_distrib.svg.png
		var chartOptions = {
			series: [{name: 'Event Count', data: this.eventPairs}],
			chart: {renderTo: renderPlace, type: 'column'},
			title: {text: renderPlace},
			legend: {enabled: false},
			credits: {enabled: false}
		}
		return chartOptions
	}

	// Function that does all calculation.
	function execute() {
		//Pull in variables from the document.
		var nodesPerUser = Number(document.getElementById('nodesPerUser').value)
		var computeNodes = Number(document.getElementById('computeNodes').value)
		var usersPerDay = Number(document.getElementById('usersPerDay').value)
		var simDays = Number(document.getElementById('simDays').value)

		// Initialize our probability mass funtions for arrivals and load sizes.
		var arrivalDistribution = new ProbMass([[6,2],[7,5],[8,8],[9,11],[10,12],[11,12],[12,12],[13,12],[14,11],[15,8],[16,5],[17,2]])
		var loadSizeDistribution = new ProbMass([[1,50],[2,25],[3,12],[4,6],[5,3],[6,1],[7,1],[8,1],[9,1]])
		// Draw the distributions:
		new Highcharts.Chart(arrivalDistribution.toHighChartDesc('arrivalDistGraph'))
		new Highcharts.Chart(loadSizeDistribution.toHighChartDesc('loadDistGraph'))

		// Generating Users
		function randomUserGen(numOfUsers) {
			var userList = []
			for (var i=0;i<numOfUsers;i++) {
				var arrSample = arrivalDistribution.sample()
				var loadSample = loadSizeDistribution.sample()
				var randomUser = {GUID:i, arrivalTime:arrSample, loadSize:loadSample, expectedWait:loadSample/Math.min(nodesPerUser,computeNodes), actualWait:null}
				userList.push(randomUser)
			}
			return userList
		}
		randomUsers = randomUserGen(usersPerDay)

		// Drawing the Arrivals
		arrivalCounts = []
		loadTotals = []
		for (var i=0;i<24*simDays;i++) {
			arrivalCounts[i] = null
			loadTotals[i] = null
			for (j=0;j<randomUsers.length;j++) {
				if (randomUsers[j]['arrivalTime'] == i) {
					arrivalCounts[i] += 1
					loadTotals[i] += randomUsers[j]['loadSize']
				}
			}
		}
		var arrivalChartOptions = {
			series: [{name: 'Arrivals', type:'column', data: arrivalCounts},{name:'Total Load Addition', type:'line', data:loadTotals}],
			chart: {renderTo: 'arrivalData'},
			plotOptions: {column:{stacking: 'normal'}},
			title: {text: 'Arrival Data'},
			legend: {enabled: false},
			credits: {enabled: false},
			yAxis: {title:{text:null}, endOntick:false}
		}
		$('<div>').attr('id','arrivalData').attr('style','height:400px').appendTo('#output')
		new Highcharts.Chart(arrivalChartOptions)

		// Drawing the nodes working and queue:
		nodesWorking = []
		queueSize = []
		for (var i=0;i<24*simDays;i++) {
			// Pull the new loads and past queue into the current queue.
			if (i>0) {queueSize[i] = queueSize[i-1] + loadTotals[i]}
			else {queueSize[i] = loadTotals[i]}
			// Set as many nodes working as possible.
			nodesWorking[i] = Math.min(queueSize[i], computeNodes)
			// Take current work we're doing off the queue.
			queueSize[i] = queueSize[i] - nodesWorking[i]
		}
		var workAndQueue = {
			series: [{name: 'Nodes Working', type:'column', data: nodesWorking},{name:'queueSize', type:'column', data:queueSize.map(function(x){return -1*x})}],
			chart: {renderTo: 'workAndQueue'},
			plotOptions: {column:{stacking: 'normal'}},
			title: {text: 'Nodes Working and Queue'},
			legend: {enabled: false},
			credits: {enabled: false},
			yAxis: {title:{text:null},max:1.1*computeNodes, endOntick:false}
		}
		new Highcharts.Chart(workAndQueue)
	}
	
	// Run calculations on load.
	execute()
</script>